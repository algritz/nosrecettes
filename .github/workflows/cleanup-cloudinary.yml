name: Cleanup Cloudinary Images

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  cleanup-images:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need current and previous commit

      - name: Detect removed Cloudinary images
        id: detect-images
        run: |
          echo "Analyzing git diff for removed Cloudinary images..."

          # Get the diff between the merge commit and its parent
          DIFF=$(git diff HEAD~1 HEAD)

          # Extract removed lines containing Cloudinary URLs
          # Look for lines starting with - that contain res.cloudinary.com/nosrecettes
          REMOVED_LINES=$(echo "$DIFF" | grep "^-.*res\.cloudinary\.com/nosrecettes/image/upload" || true)

          if [ -z "$REMOVED_LINES" ]; then
            echo "No Cloudinary images removed in this PR"
            echo "cleanup_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found removed Cloudinary URLs:"
          echo "$REMOVED_LINES"

          # Extract public IDs (recipes/{slug} pattern)
          # The pattern matches: recipes/ followed by alphanumeric, hyphens, or underscores
          PUBLIC_IDS=$(echo "$REMOVED_LINES" | grep -oE 'recipes/[a-zA-Z0-9_-]+' | sort -u)

          if [ -z "$PUBLIC_IDS" ]; then
            echo "No valid public IDs found for cleanup"
            echo "cleanup_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Extracted unique public IDs for cleanup:"
          echo "$PUBLIC_IDS"

          # Save to file for next steps
          echo "$PUBLIC_IDS" > cleanup_list.txt

          # Count images
          IMAGE_COUNT=$(echo "$PUBLIC_IDS" | wc -l | tr -d ' ')
          echo "cleanup_needed=true" >> $GITHUB_OUTPUT
          echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        if: steps.detect-images.outputs.cleanup_needed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Cloudinary CLI
        if: steps.detect-images.outputs.cleanup_needed == 'true'
        run: npm install -g cloudinary-cli

      - name: Cleanup Cloudinary images
        if: steps.detect-images.outputs.cleanup_needed == 'true'
        env:
          CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
        run: |
          echo "Starting Cloudinary cleanup..."

          SUCCESS_COUNT=0
          FAIL_COUNT=0

          while IFS= read -r public_id; do
            if [ -n "$public_id" ]; then
              echo "Attempting to delete: $public_id"

              if cld destroy "$public_id" 2>/dev/null; then
                echo "‚úÖ Successfully deleted: $public_id"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "‚ö†Ô∏è  Failed to delete or image not found: $public_id"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            fi
          done < cleanup_list.txt

          echo "Cleanup completed: $SUCCESS_COUNT succeeded, $FAIL_COUNT failed"
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT

      - name: Comment on PR with cleanup results
        if: steps.detect-images.outputs.cleanup_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## üßπ Cloudinary Cleanup Results\n\n';

            if (fs.existsSync('cleanup_list.txt')) {
              const publicIds = fs.readFileSync('cleanup_list.txt', 'utf8')
                .trim()
                .split('\n')
                .filter(id => id.trim());

              if (publicIds.length > 0) {
                comment += `‚úÖ Automatically detected and cleaned up ${publicIds.length} removed image(s):\n\n`;
                publicIds.forEach(id => {
                  comment += `- \`${id.trim()}\`\n`;
                });
                comment += '\n*Images were detected by analyzing git diff for removed Cloudinary URLs.*';
              }
            } else {
              comment += '‚ö†Ô∏è No cleanup list generated.';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Skip cleanup notification
        if: steps.detect-images.outputs.cleanup_needed == 'false'
        run: |
          echo "‚úÖ No removed Cloudinary images detected - skipping cleanup"
